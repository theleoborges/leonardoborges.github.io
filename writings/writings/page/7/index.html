
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Leonardo Borges</title>
	<meta name="author" content="Leonardo Borges">

	
	<meta name="description" content="Next week the RuPy Conference 2009 will be held in Poznan, Poland and I was planning to talk there.My talk had been approved and everything was &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="http://feeds.feedburner.com/leonardoborges" rel="alternate" title="Leonardo Borges" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/writings/favicon.png" rel="shortcut icon">
	<link href="/writings/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>

<body>
	<header id="header" class="inner"><h1><a href="/writings/">Leonardo Borges</a></h1>
<nav id="main-nav"><ul class="main-navigation">
  <li><a href="/writings/">Blog</a></li>
  <li><a href="/writings/about">About</a></li>
  <li><a href="/writings/projects">Projects</a></li>
  <li><a href="/writings/presentations">Talks</a></li>
  <li><a href="/writings/books">Books</a></li>
  <li><a href="/writings/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main-navigation">
  <li><a href="/writings/">Blog</a></li>
  <li><a href="/writings/about">About</a></li>
  <li><a href="/writings/projects">Projects</a></li>
  <li><a href="/writings/presentations">Talks</a></li>
  <li><a href="/writings/books">Books</a></li>
  <li><a href="/writings/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:www.leonardoborges.com/writings">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/leonardo_borges" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/leonardoborges" title="GitHub">GitHub</a>
		
		
		
		
		
		<a class="rss" href="http://feeds.feedburner.com/leonardoborges" title="RSS">RSS</a>
		
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:www.leonardoborges.com/writings">
	</form>
</nav>

</header>
	
		
<!-- <div id="banner" class="inner"> -->
<!--     <div class="container"> -->
<!--         <ul class="feed"></ul> -->
<!--     </div> -->
<!--     <small><a href="http://twitter.com/leonardo_borges">leonardo_borges</a> @ <a href="http://twitter.com">Twitter</a></small> -->
<!--     <div class="loading">Loading...</div> -->
<!-- </div> -->
<!-- <script src="/writings/javascripts/twitter.js"></script> -->
<!-- <script type="text/javascript"> -->
<!--     (function($){ -->
<!--         $('#banner').getTwitterFeed('leonardo_borges', 4, false); -->
<!--     })(jQuery); -->
<!-- </script> -->


	
	<div id="content" class="inner">


    <article class="post">
	<h1 class="title"><a href="/writings/2009/11/04/rupy-2009-poznan/">RuPy 2009: Poznan</a></h1>
	<div class="entry-content">
		<p>
Next week the <a href="http://rupy.eu/">RuPy Conference 2009</a> will be held in Poznan, Poland and I was planning to talk there.<br><br>My talk had been approved and everything was looking good - I was gonna talk about JRuby in the Enterprise - until <a href="http://www.leonardoborges.com/writings/2009/10/08/soon-off-to-conquer-lands-afar/">my move to ThoughtWorks</a> became a reality less than a month ago.<br><br>This move led to a lack of support and time from my current company. I was counting on it to go there but since I&#8217;ll be leaving soon, that wouldn&#8217;t be possible.<br><br>Since then I&#8217;ve been in touch with Adam Parchimowicz - part of RuPy&#8217;s organization team - and we tried to find alternatives to this. I wanted to thank him for all the effort he put into trying to make this happen. The terms we agreed on were good enough but this change of priorities kicked in too close to the event.<br><br>Long story short, I&#8217;d like to apologize for not being able to give my talk at RuPy this year.<br><br>Apart from that, I gave a very similar talk at the <a href="http://www.railssummit.com.br/">Rails Summit Latin America</a> this year in Brazil and you can find the slides and sources for it in my <a href="http://www.leonardoborges.com/writings/presentations/">Presentations</a> page. ( Video coming soon )
</p>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2009-11-04T00:00:00+11:00" pubdate data-updated="true">Nov 4<span>th</span>, 2009</time></div>
	<div class="tags">


	<a class='category' href='/writings/tags/world/'>World</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/writings/2009/10/18/my-slides-from-rails-summit-09/">My Slides From Rails Summit &#8216;09</a></h1>
	<div class="entry-content">
		<p>
<a href='/writings/assets/images/rs2009.jpg'><img src="/writings/assets/images/rs2009.jpg"></a><br>Rails Summit finished a few days ago and I have only one word to describe it: <strong>Awesome</strong>!<br><br>I met some really cool people, discussed a whole bunch of technical subjects and managed not to get so nervous in my first presentation ever - I&#8217;m not counting internal presentations I&#8217;ve done for my team&#8230;<br><br>My slides and source files can be found <a href="http://github.com/leonardoborges/railssummit09">here</a>. Feel free to contact me with questions if you got any.
</p>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2009-10-18T00:00:00+11:00" pubdate data-updated="true">Oct 18<span>th</span>, 2009</time></div>
	<div class="tags">


	<a class='category' href='/writings/tags/conferences/'>Conferences</a>, <a class='category' href='/writings/tags/railssummit2009/'>RailsSummit2009</a>, <a class='category' href='/writings/tags/world/'>World</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/writings/2009/10/08/soon-off-to-conquer-lands-afar/">Soon, Off to Conquer Lands Afar</a></h1>
	<div class="entry-content">
		<p>
Once more my life is taking a huge turn.<br><br>I&#8217;ve been pretty quiet for the past month and honestly don&#8217;t know how I managed to hold in my excitement. I&#8217;ve just accepted an offer from <a href="http://www.thoughtworks.com.au/" target="_blank">ThoughtWorks</a> to be based at their australian offices, either in Sydney or Melbourne, depending  on where my 1st project will be.<br><br>For those of you who don&#8217;t know, ThoughtWorks is a global IT consultancy that is really well known in the software development community. It&#8217;s been advocating agile methodologies and test-driven development for several years now and seems to work really hard to attract and keep <a title="Martin Fowler" href="http://www.martinfowler.com" target="_blank">many</a> <a title="Rebecca Parsons" href="http://www.thoughtworks.com/who-we-are/leadership-profiles/rebecca-parsons.html" target="_blank">bright</a> <a title="Neal Ford" href="http://www.nealford.com/" target="_blank">people</a> <a title="Ola Bini" href="http://olabini.com/" target="_blank">working</a> <a title="All ThoughtWorkers" href="http://www.thoughtworks.com/who-we-are/our-people/profiles.html" target="_blank">there</a>.<br><br>As a result, ThoughtWorks inspires companies and professionals around the world by delivering high quality projects and massively supporting/contributing to <a title="Projects created/contributed to by ThoughtWorks" href="http://opensource.thoughtworks.com" target="_blank">open source projects</a>.<br><br>Needless to say, I am really excited to be joining a company with such an amazing culture and so many smart people.<br><br>The hiring process was long, tough and tiring - but yet enjoyable. It took 5 interviews, 1 code review and 1 pairing session, a process through which I talked to 8 thoughtworkers. They take pride on their hiring process and now I understand why.<br><br>Now I&#8217;m just going through the bureaucratic side of things: gathering documents, certificates, translations - all in order to apply for my VISA, which can take up to 3 months to get ready. In the meantime, you can still find me here in Madrid, where I&#8217;ll be celebrating with a few &#8216;cañas&#8217;. Feel free to join me! ;)
</p>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2009-10-08T00:00:00+11:00" pubdate data-updated="true">Oct 8<span>th</span>, 2009</time></div>
	<div class="tags">


	<a class='category' href='/writings/tags/thoughtworks/'>ThoughtWorks</a>, <a class='category' href='/writings/tags/world/'>World</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/writings/2009/10/07/a-few-more-thoughts-on-final-classes/">A Few More Thoughts on Final Classes</a></h1>
	<div class="entry-content">
		<p>
I <a href="http://www.leonardoborges.com/writings/2009/03/17/final-classes-are-evil/" target="_blank">said final classes are evil</a> and that post got some attention with interesting comments. Maybe because of the title and the tone I wrote it, a few comments didn&#8217;t get my real intention and perhaps I should have been more explicit about it. Go ahead and <a href="http://www.leonardoborges.com/writings/2009/03/17/final-classes-are-evil/" target="_blank">read it</a>. I&#8217;ll wait. :)<br><br>Anyway, I thought I&#8217;d expand a little more on that subject, explaining my motivation to write that post and going through the topics I think were raised by my dear readers.<br><br>First off, final classes <strong>are evil for testing</strong>. And that&#8217;s what it was all about in my previous post.<br><br>If you depend on a final class, your code will be harder to test. Unless the final class provides an interface that captures its intent - or you wrap that dependency.<br><br>But this affirmation has some implications that were pointed out by a few comments, some of which I agree with - others, not so much. So let&#8217;s start!<br><br><strong>- Immutability </strong><br><br><span style="background-color: #ffffff;">Someone said &#8220;Why make a class final ? To make it immutable&#8221;. This is not entirely true. Only by marking it final you do not ensure immutability. There is no point in doing that if you provide mutators - e.g. setters. - and don&#8217;t declare your members private and final.</span><br><br>I think it&#8217;s important to make this clear and understand that the immutability part you achieve by marking a class final is the one of preventing inheritance. Subclasses could possibly contain malicious/careless code and change the internal state of the class.<br><br><span style="background-color: #ffffff;">But there is another way of preventing subclassing without marking the parent final: declare its constructor private and provide a <a href="http://www.javapractices.com/topic/TopicAction.do?Id=21" target="_blank">static factory</a>.</span><br><br><strong>- Designing for extensibility</strong><br><br>This is hard. It basically means that if you don&#8217;t mark a class final, you should document it for inheritance.<br><br>And this is why inheritance is, in general, a bad OO practice. By documenting the class you basically break encapsulation since you tell the world about your internals.<br><br>Therefore, the recommendation is to mark a class final if you&#8217;re not sure if it&#8217;s safe to subclass it - or if you just don&#8217;t wanna bother writing documentation and thinking too much about your &#8220;client&#8221; subclasses.<br><br><strong>- Coding against interfaces</strong><br><br>This one is simple but yet often forgotten. Do not code to concrete classes. Always choose interfaces where possible.<br>It roughly means to do this:<br><pre lang="java">  List args = new ArrayList();</pre><br>instead of this:<br><pre lang="java">  ArrayList args = new ArrayList();</pre><br>By doing so you have the flexibility to not care about the implementation you&#8217;re working with, as long as it obeys the interface. That way, the implementations can be swapped at any time without breaking any client&#8217;s code.<br><br><strong>- The problem with testing</strong><br><br><strong></strong>All items listed here so far are widely regarded as best practices and the bullet I raised about hard testing usually happens when you &#8220;violate&#8221; some of them.<br><br>Specifically, if you decide not to design a class for inheritance and mark it as final, it&#8217;s wise - in my opinion - to try and capture the class&#8217;s intent through an interface.<br><br>That way you can safely mark your class final and users of your class can easily use the interface to extend it - by favoring <a href="http://www.artima.com/lejava/articles/designprinciples4.html" target="_blank">composition over inheritance</a> - or by providing it to mocking frameworks for easy testing.<br><br><strong>- Conclusion</strong><br><br>I don&#8217;t really think there is a rule of thumb here. Java&#8217;s standard library shows many examples of both approaches and some of them are now considered bad practices but yet are there for backward compatibility. Nevertheless, these are points to consider when designing your classes.<br><br>As pointed out by Josua Bloch in his awesome book <a href="http://www.shelfari.com/books/purchase?EditionId=1523265&amp;AssociateId=leonaborge-20&amp;WidgetId=111594" target="_blank">Effective Java</a>, &#8220;If a concrete class does not implement a standard interface, then you may inconvenience some programmers by prohibiting inheritance&#8221;.<br><br>As usual, comments are more than welcome :)
</p>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2009-10-07T00:00:00+11:00" pubdate data-updated="true">Oct 7<span>th</span>, 2009</time></div>
	<div class="tags">


	<a class='category' href='/writings/tags/architecture/'>Architecture</a>, <a class='category' href='/writings/tags/java/'>Java</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/writings/2009/09/18/refactoring-for-readability/">Refactoring for Readability</a></h1>
	<div class="entry-content">
		<p>
Yesterday I&#8217;ve done something I should do more often: Revisit some code written a while ago for our current project and make it better.<br><br>Let&#8217;s face it. We all write crappy code the 1st time. The difference is in what we do about it afterwards.<br>We might decide it&#8217;s good enough and keep moving, or we could (and should!) stop and refactor it!<br><br>The code I revisited worked as a refactoring exercise and it&#8217;s initial version is shown below:

<figure class='code'><figcaption><span>Jphoto</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Jphoto</span>
</span><span class='line'> <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'> <span class="c1">#a few other methods ...</span>
</span><span class='line'>
</span><span class='line'> <span class="k">def</span> <span class="nf">post_photo</span><span class="p">(</span><span class="n">file_data</span><span class="p">,</span> <span class="n">hotel_id</span><span class="p">,</span> <span class="n">send_rss</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class='line'>   <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;tmp/</span><span class="si">#{</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">to_i</span><span class="si">}</span><span class="s2">_</span><span class="si">#{</span><span class="nb">rand</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">36</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>   <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>     <span class="n">f</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">params</span> <span class="o">=</span> <span class="o">[</span><span class="no">Curl</span><span class="o">::</span><span class="no">PostField</span><span class="o">.</span><span class="n">file</span><span class="p">(</span><span class="s1">&#39;photo&#39;</span><span class="p">,</span><span class="n">file_name</span><span class="p">),</span>
</span><span class='line'>      <span class="no">Curl</span><span class="o">::</span><span class="no">PostField</span><span class="o">.</span><span class="n">content</span><span class="p">(</span><span class="s1">&#39;hotel&#39;</span><span class="p">,</span> <span class="n">hotel_id</span><span class="p">),</span>
</span><span class='line'>      <span class="no">Curl</span><span class="o">::</span><span class="no">PostField</span><span class="o">.</span><span class="n">content</span><span class="p">(</span><span class="s1">&#39;source&#39;</span><span class="p">,</span><span class="s1">&#39;PhotoUploadTest&#39;</span><span class="p">)</span><span class="o">]</span>
</span><span class='line'>   <span class="n">extract_extra_params!</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">c</span> <span class="o">=</span> <span class="no">Curl</span><span class="o">::</span><span class="no">Easy</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">service_uri_base</span><span class="si">}</span><span class="s2">/photoupld&quot;</span><span class="p">)</span>
</span><span class='line'>   <span class="n">c</span><span class="o">.</span><span class="n">multipart_form_post</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>   <span class="n">c</span><span class="o">.</span><span class="n">http_post</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">response_code</span> <span class="o">!=</span> <span class="mi">200</span>
</span><span class='line'>     <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;File upload failed with code: </span><span class="si">#{</span><span class="n">c</span><span class="o">.</span><span class="n">response_code</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>     <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="n">error_msg</span>
</span><span class='line'>     <span class="k">raise</span> <span class="n">error_msg</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>   <span class="no">File</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">hotel</span> <span class="o">=</span> <span class="no">Hotel</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">hotel_id</span><span class="p">)</span>
</span><span class='line'>   <span class="n">hotel</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">destroy_all</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">send_upload_rss</span><span class="p">(</span><span class="n">hotel</span><span class="p">,</span> <span class="n">original_upload_url</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">body_str</span><span class="p">)</span> <span class="p">,</span> <span class="n">options</span><span class="p">)</span> <span class="k">if</span> <span class="n">send_rss</span>
</span><span class='line'> <span class="k">end</span>
</span><span class='line'>
</span><span class='line'> <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'> <span class="k">def</span> <span class="nf">send_upload_rss</span><span class="p">(</span><span class="n">hotel</span><span class="p">,</span> <span class="n">photo_url</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'>   <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'> <span class="k">end</span>
</span><span class='line'> <span class="k">def</span> <span class="nf">manage_images_link</span><span class="p">(</span><span class="n">hotel_id</span><span class="p">)</span>
</span><span class='line'>   <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'> <span class="k">end</span>
</span><span class='line'>
</span><span class='line'> <span class="k">def</span> <span class="nf">extract_extra_params!</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'>   <span class="n">params</span> <span class="o">&lt;&lt;</span> <span class="no">Curl</span><span class="o">::</span><span class="no">PostField</span><span class="o">.</span><span class="n">content</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span><span class="p">)</span> <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span>
</span><span class='line'>   <span class="n">params</span> <span class="o">&lt;&lt;</span> <span class="no">Curl</span><span class="o">::</span><span class="no">PostField</span><span class="o">.</span><span class="n">content</span><span class="p">(</span><span class="s1">&#39;upload_source&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">[</span><span class="ss">:upload_source</span><span class="o">]</span><span class="p">)</span> <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:upload_source</span><span class="o">]</span>
</span><span class='line'>   <span class="n">params</span> <span class="o">&lt;&lt;</span> <span class="no">Curl</span><span class="o">::</span><span class="no">PostField</span><span class="o">.</span><span class="n">content</span><span class="p">(</span><span class="s1">&#39;uploader_ip&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">[</span><span class="ss">:uploader_ip</span><span class="o">]</span><span class="p">)</span> <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:uploader_ip</span><span class="o">]</span>
</span><span class='line'>   <span class="n">params</span> <span class="o">&lt;&lt;</span> <span class="no">Curl</span><span class="o">::</span><span class="no">PostField</span><span class="o">.</span><span class="n">content</span><span class="p">(</span><span class="s1">&#39;uploader_email&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">[</span><span class="ss">:uploader_email</span><span class="o">]</span><span class="p">)</span> <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:uploader_email</span><span class="o">]</span>
</span><span class='line'> <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<br>Look at the post_photo method. It has problems in so many levels that it&#8217;s hard to start. <br>Methods should do &#8220;one thing&#8221; and that method obviously does much more than that, mixing different levels of abstraction.<br><br>But let&#8217;s start with the easy parts first, keeping in mind that I was aiming for readability.<br><br>Lines 7 to 10 seem to be there just to make the reader&#8217;s life harder. It&#8217;s creating a temporary file through some custom logic instead of using the tools provided by the language. Unnecessary and only pollutes our eyes. My first measure was to use ruby&#8217;s TempFile class for this. Better, but we still have a long way.<br><br>Right at line 12 it creates some sort of default parameters list, after which it extracts some extra options. I don&#8217;t know what that method does but it&#8217;s clearly using output arguments, which we should avoid at all costs, as they lead to confusion. This is a big smell as well, and another refactoring step added to my list.<br><br>On line 21 starts the code that handles what to do when we get a response_code other than 200 from our request. Apart from the fact that this code doesn&#8217;t feel right here, we just happen to know that in HTTP, 200 means success, but that might not be clear to someone looking at the code for the 1st time.<br><br>Then the code goes on to delete the temp file, clear the hotel&#8217;s cache and send the rss if the rss&#8217; flag is true.<br><br><strong>Let there be refactoring&#8230;.</strong><br><br>Geez, how many lines have I used to explain what the code does? Since I don&#8217;t wanna bore you to death, here is my refactored version of this method, trying to avoid as much as I can the problems I highlighted previously:<br><br><br><br>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Jphoto</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>  <span class="no">SUCCESS</span> <span class="o">=</span> <span class="mi">200</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#a few other methods ...</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">post_photo</span><span class="p">(</span><span class="n">file_data</span><span class="p">,</span> <span class="n">hotel_id</span><span class="p">,</span> <span class="n">send_rss</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class='line'>    <span class="n">response_body</span> <span class="o">=</span> <span class="n">make_post_request</span><span class="p">(</span><span class="n">file_data</span><span class="p">,</span> <span class="n">hotel_id</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'>    <span class="n">hotel</span> <span class="o">=</span> <span class="no">Hotel</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">hotel_id</span><span class="p">)</span>
</span><span class='line'>    <span class="n">hotel</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">destroy_all</span>
</span><span class='line'>    <span class="n">send_upload_rss</span><span class="p">(</span><span class="n">hotel</span><span class="p">,</span> <span class="n">original_upload_url</span><span class="p">(</span><span class="n">response_body</span><span class="p">)</span> <span class="p">,</span> <span class="n">options</span><span class="p">)</span> <span class="k">if</span> <span class="n">send_rss</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>

Ha! That reads much nicer, right? 
Below you&#8217;ll find the rest of the class, properly refactored. Note how I also changed the order of the private methods so the class has a reading flow. 
You can now read it top down, without scrolling through the file several times trying to find where the methods are defined.

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="kp">private</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">make_post_request</span><span class="p">(</span><span class="n">file_data</span><span class="p">,</span> <span class="n">hotel_id</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'>    <span class="n">temp_file</span> <span class="o">=</span> <span class="no">Tempfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;minisite_upload_&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">temp_file</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>
</span><span class='line'>    <span class="n">c</span> <span class="o">=</span> <span class="no">Curl</span><span class="o">::</span><span class="no">Easy</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">service_uri_base</span><span class="s1">&#39;]}/photoupld&quot;)</span>
</span><span class='line'><span class="s1">    c.multipart_form_post = true</span>
</span><span class='line'><span class="s1">    c.http_post(*build_params_list(temp_file.path, hotel_id, options))</span>
</span><span class='line'><span class="s1">    temp_file.delete</span>
</span><span class='line'><span class="s1">    raise_and_log_error(&quot;File upload failed with code: #{c.response_code}&quot;) if c.response_code != SUCCESS</span>
</span><span class='line'><span class="s1">    c.body_str</span>
</span><span class='line'><span class="s1">  end</span>
</span><span class='line'><span class="s1">  def build_params_list(file_path, hotel_id, options)</span>
</span><span class='line'><span class="s1">    params = [Curl::PostField.file(&#39;</span><span class="n">photo</span><span class="s1">&#39;, file_path), Curl::PostField.content(&#39;</span><span class="n">hotel</span><span class="s1">&#39;, hotel_id), Curl::PostField.content(&#39;</span><span class="n">source</span><span class="s1">&#39;,&#39;</span><span class="no">PhotoUploadTest</span><span class="s1">&#39;)]</span>
</span><span class='line'><span class="s1">    params &lt;&lt; Curl::PostField.content(&#39;</span><span class="n">status</span><span class="s1">&#39;, options[:status]) if options[:status]</span>
</span><span class='line'><span class="s1">    params &lt;&lt; Curl::PostField.content(&#39;</span><span class="n">upload_source</span><span class="s1">&#39;, options[:upload_source]) if options[:upload_source]</span>
</span><span class='line'><span class="s1">    params &lt;&lt; Curl::PostField.content(&#39;</span><span class="n">uploader_ip</span><span class="s1">&#39;, options[:uploader_ip]) if options[:uploader_ip]</span>
</span><span class='line'><span class="s1">    params &lt;&lt; Curl::PostField.content(&#39;</span><span class="n">uploader_email</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">[</span><span class="ss">:uploader_email</span><span class="o">]</span><span class="p">)</span> <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:uploader_email</span><span class="o">]</span>
</span><span class='line'>    <span class="n">params</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">raise_and_log_error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
</span><span class='line'>    <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="n">error_msg</span>
</span><span class='line'>    <span class="k">raise</span> <span class="n">error_msg</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">original_upload_url</span><span class="p">(</span><span class="n">jphotos_response</span><span class="p">)</span>
</span><span class='line'>    <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">send_upload_rss</span><span class="p">(</span><span class="n">hotel</span><span class="p">,</span> <span class="n">photo_url</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'>    <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">manage_images_link</span><span class="p">(</span><span class="n">hotel_id</span><span class="p">)</span>
</span><span class='line'>    <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


I&#8217;ve only applied 2 basic principles to this code: That methods should do one thing and that they should avoid output arguments. But the result was a drastic improvement over the old code.
<strong>A last step&#8230;</strong>
There is still one thing I would like to change in the post_photo method. It takes a boolean as an argument. The first time you see a call to this method, there is no way you can tell what that flag is used for:

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">jphoto</span><span class="o">.</span><span class="n">post_photo</span><span class="p">(</span><span class="n">file_data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">false</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

To make it more clear we could refactor the method once more to look like this:


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">post_photo_and_send_rss</span><span class="p">(</span><span class="n">file_data</span><span class="p">,</span> <span class="n">hotel_id</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class='line'>    <span class="n">response_body</span> <span class="o">=</span> <span class="n">post_photo</span><span class="p">(</span><span class="n">file_data</span><span class="p">,</span> <span class="n">hotel_id</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'>    <span class="n">send_upload_rss</span><span class="p">(</span><span class="n">hotel</span><span class="p">,</span> <span class="n">original_upload_url</span><span class="p">(</span><span class="n">response_body</span><span class="p">)</span> <span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">post_photo</span><span class="p">(</span><span class="n">file_data</span><span class="p">,</span> <span class="n">hotel_id</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class='line'>    <span class="n">response_body</span> <span class="o">=</span> <span class="n">make_post_request</span><span class="p">(</span><span class="n">file_data</span><span class="p">,</span> <span class="n">hotel_id</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'>    <span class="n">hotel</span> <span class="o">=</span> <span class="no">Hotel</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">hotel_id</span><span class="p">)</span>
</span><span class='line'>    <span class="n">hotel</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">destroy_all</span>
</span><span class='line'>    <span class="n">response_body</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>	

This way we avoid an extra parameter and save our reader - and possibly us - of the trouble to guess what that flag was for.<br><br><br>I am by no means saying this is the definitive refactored state of this code but instead sharing the steps I went through while refactoring it. As always, tips and comments are welcome! :) 
</p>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2009-09-18T00:00:00+10:00" pubdate data-updated="true">Sep 18<span>th</span>, 2009</time></div>
	<div class="tags">


	<a class='category' href='/writings/tags/jruby/'>JRuby</a>, <a class='category' href='/writings/tags/refactoring/'>Refactoring</a>, <a class='category' href='/writings/tags/ruby/'>Ruby</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/writings/2009/09/03/rails-summit-2009-im-speaking/">Rails Summit 2009: I&#8217;m Speaking</a></h1>
	<div class="entry-content">
		<p>
<a href="http://www.railssummit.com.br?utm_campaign=Railssummit&amp;utm_source=banner_parceiros&amp;utm_medium=banner&amp;utm_content=en_souPalestrante_210x60"><img src="http://railssummit.com.br/images/banners/en_souPalestrante_210x60.jpg" alt="Rails Summit 2009" /></a><br><br>I&#8217;ll be speaking at this year&#8217;s <a href="http://railssummit.com.br/en/pages/home" target="_blank">Rails Summit Latin America</a> in Sao Paulo, Brazil. It will be a good opportunity to meet some <a href="http://railssummit.com.br/en/speakers">amazing people</a> and visit friends back home! :)<br><br>Overall I&#8217;ll be spending 12 days in Brazil, with 2 of them dedicated to the conference. The other 10 I&#8217;ll be in Rio de Janeiro visiting my family and friends. I strongly advise you to spend some time in Rio too, if at all possible. It&#8217;s an amazing city and you can contact me if you have any questions.<br><br>Back to the conference, my session is called <strong>JRuby in the enterprise world: Using Rails with legacy code</strong>, and will be given in the form of a tutorial. I will walk you through some problems we had while making this kind of integration at my company, focusing mostly on dependency management.<br><br>At the end I hope you&#8217;ll have a good understanding of what JRuby is capable of in a legacy environment.<br><br>If you&#8217;re planning to attend and would like to hear anything specific about JRuby, please let me know, I can try and squeeze in.<br><br>C u there!
</p>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2009-09-03T00:00:00+10:00" pubdate data-updated="true">Sep 3<span>rd</span>, 2009</time></div>
	<div class="tags">


	<a class='category' href='/writings/tags/conferences/'>Conferences</a>, <a class='category' href='/writings/tags/jruby/'>JRuby</a>, <a class='category' href='/writings/tags/rails/'>Rails</a>, <a class='category' href='/writings/tags/ruby/'>Ruby</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/writings/2009/08/25/rails-rumble-09/">Rails Rumble &#8216;09</a></h1>
	<div class="entry-content">
		<p>
<strong>Update:</strong> The service is now down while we move it from the VPS provided by Rails Rumble to our own. I&#8217;ll let you know once it&#8217;s up.<br><br>Last weekend <a href="http://www.ivercore.com/" target="_blank">Philip</a>, <a href="http://www.pedropimentel.com/" target="_blank">Pedro</a> and myself got together for this year&#8217;s <a href="http://railsrumble.com/" target="_blank">Rails Rumble</a>.<br><br>We haven&#8217;t had really decided what to do until a few days before the competition, but I had this really simple idea and decided to go with it. Seems people liked it, given a few positive comments we received.<br><br>So, after 48 hours - which were not used to work full-time in the application - <a href="http://birdwatcher.r09.railsrumble.com/">The Bird Watcher</a> was born.<br><br><a href="http://birdwatcher.r09.railsrumble.com/">The Bird Watcher</a> is a simple way to show the world what&#8217;s going on on Twitter for any topic you define.  Go ahead and take a look at the website to see a live example.<br><br>We&#8217;re planning to keep the service up after the competition is over and we have some nice features lined up to go live on the next release.<br><br>In short, it was an interesting weekend and showed me that this team works really well together.<br><br>Cheers
</p>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2009-08-25T00:00:00+10:00" pubdate data-updated="true">Aug 25<span>th</span>, 2009</time></div>
	<div class="tags">


	<a class='category' href='/writings/tags/rails/'>Rails</a>, <a class='category' href='/writings/tags/ruby/'>Ruby</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/writings/2009/07/31/jvm-language-preferences-poll-results/">JVM Language Preferences Poll Results</a></h1>
	<div class="entry-content">
		<p>
<strong>- Overall results</strong><br><br>First off, I&#8217;d like to thank everyone who voted on this poll.<br>With a total of 236 votes, here is the summary of the first two questions:<br><br><strong>- Are you currently working with or researching about language alternatives for the JVM? - e.g. JRuby, Scala, Groovy</strong><br><br><a href='/writings/assets/images/scala_improvements.png'><img src="/writings/assets/images/scala_improvements.png"></a></em><br><br>Tooling. The majority of comment urge for better tooling and IDE support. That simple.<br><br><strong>- Others</strong><br><br>People who chose others mentioned <a href="http://clojure.org/" target="_blank">Clojure</a>, <a href="http://www.fandev.org/" target="_blank">Fan</a> and <a href="http://www.jython.org/">Jython</a>, with a clear advantage for Clojure.<br><br><strong>- Disclaimer</strong><br><br><strong>This poll has no scientific foundations whatsoever and its sole purpose is to summarize the feelings and personal choices of the people who answered it. If you would like the original spreadsheet with the answers, you can find it <a href="http://spreadsheets.google.com/ccc?key=0AuABB6DyTXV2dHEtZnNwSDhCb2RVOThFcUNaSUhpbEE&amp;hl=en" target="_blank">here</a> and do your own analyzis.<br></strong>
</p>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2009-07-31T00:00:00+10:00" pubdate data-updated="true">Jul 31<span>st</span>, 2009</time></div>
	<div class="tags">


	<a class='category' href='/writings/tags/groovy/'>Groovy</a>, <a class='category' href='/writings/tags/jruby/'>JRuby</a>, <a class='category' href='/writings/tags/jvm/'>JVM</a>, <a class='category' href='/writings/tags/java/'>Java</a>, <a class='category' href='/writings/tags/ruby/'>Ruby</a>, <a class='category' href='/writings/tags/scala/'>Scala</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/writings/2009/07/22/procs-lambdas-blocks-whats-the-difference/">Procs, Lambdas, Blocks?! What&#8217;s the Difference?</a></h1>
	<div class="entry-content">
		<p>
Do you know? <br>I didn&#8217;t. And started to get annoyed by using these terms interchangeably and not really knowing the difference.<br><br>There are a few. And they are subtle. I don&#8217;t think most of us would ever have problems with it but it&#8217;s the kind of information you&#8217;ll be glad to know when having those weird behaviors in your code on a Friday at 6:01 pm, just before pushing to production. :)<br><br>I guess blocks are the most widely used term in the ruby community and there is little mistake on when to use it:<br><pre lang="ruby">[1,2,3].each do |x|<br>  puts x*2<br>end</pre><br>The code between <strong>do</strong> and <strong>end</strong> is a <strong><em>block</em></strong>.<br><br>What&#8217;s important to keep in mind is that Procs behave like blocks whereas lambdas behave like methods. To understand what that means, I highlighted a couple of examples:<br><br><strong>- The return keyword</strong><br><br>I mentioned Procs behave just like blocks and as such, the return keyword abide to the same rules. This means, for instance, that the latest puts statement on the following code snippet, will never run:<br><pre lang="ruby">def my_proc(x)<br>  p = Proc.new { puts x*2; return }<br>  p.call<br>  puts "After calling proc" #This never gets called<br>end<br>my_proc(10)<br>>>20</pre><br>For blocks - and procs-, return means &#8220;return from the calling method&#8221;, my_proc in this case. That&#8217;s why you don&#8217;t get to see the output of the puts statement.<br><br>On the other hand, in the lambda&#8217;s example, we get the opposite behavior:<br><pre lang="ruby">def my_lambda(x)<br>  p = lambda { puts x*2; return }<br>  p.call<br>  puts "After calling proc" #This time, we reach this point<br>end<br>my_lambda(10)<br>>>20<br>>>After calling proc</pre><br>Here, return says &#8220;return from the enclosing iterator&#8221;, which, in this case, just returns from the block and continnues the execution of the my_lambda method.<br><br><strong>- Argument assignment</strong><br><br>On to this second difference, procs and lambdas get more interesting when you can call them with arguments. And that&#8217;s when another subtle difference between them comes in.<br><br>I&#8217;ll start again with a proc:<br><br><pre lang="ruby"><br>  p = Proc.new { |x,y| puts x, y}<br>  p.call<br>  >>nil<br>  >>nil <br><br>  p.call(1)<br>  >>1<br>  >>nil<br><br>  p.call(1,2)<br>  >>1<br>  >>2<br><br>  p.call(1,2,3)<br>  >>1<br>  >>2<br><br>  p.call([1,2])<br>  >>1<br>  >>2<br></pre><br><br>See how procs are flexible? They basically won&#8217;t complain if you do not provide parameters, provide extra parameters or even send an array as an argument where, as seen in the code above, it unpacks the array and assign its values to the correct variables.<br><br>As you&#8217;re probably guessing, lambdas behave like methods and are much less flexible:<br><br><pre lang="ruby"><br>  l = lambda { |x,y| puts x, y}<br>  l.call<br>  >>ArgumentError: wrong number of arguments (0 for 2)<br><br>  l.call(1)<br>  >>ArgumentError: wrong number of arguments (1 for 2)<br><br>  l.call(1,2)<br>  >>1<br>  >>2<br><br>  l.call(1,2,3)<br>  >>ArgumentError: wrong number of arguments (3 for 2)<br><br>  l.call([1,2])<br>  >>ArgumentError: wrong number of arguments (1 for 2)<br></pre><br><br><br><p/><p/><br><strong>Ruby 1.9 tip</strong><br>Despite its name, Kernel.proc returns a lambda in Ruby 1.8. This has been fixed in Ruby 1.9. You actually get a Proc back.<br><br>- Reference<br><a href="http://www.amazon.com/gp/product/0596516177?ie=UTF8&tag=leonaborge-20&linkCode=as2&camp=1789&creative=9325&creativeASIN=0596516177">The Ruby Programming Language</a><img src="http://www.assoc-amazon.com/e/ir?t=leonaborge-20&l=as2&o=1&a=0596516177" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /> - A must have for any Ruby developer.<br> <br><script type="text/javascript" src="http://www.assoc-amazon.com/s/link-enhancer?tag=leonaborge-20&o=1"><br></script><br><noscript><br>    <img src="http://www.assoc-amazon.com/s/noscript?tag=leonaborge-20" alt="" /><br></noscript><br><br>
</p>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2009-07-22T00:00:00+10:00" pubdate data-updated="true">Jul 22<span>nd</span>, 2009</time></div>
	<div class="tags">


	<a class='category' href='/writings/tags/ruby/'>Ruby</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/writings/2009/07/01/jruby-on-rails-and-legacy-java-apps-managing-dependencies/">JRuby on Rails and Legacy Java Apps: Managing Dependencies</a></h1>
	<div class="entry-content">
		<p>
The motivation for this post came from a couple of messages I&#8217;ve seen on the jruby&#8217;s google group and because I think it&#8217;s pretty cool to share how we tackled this problem.<br><br><strong>- A little bit of context</strong><br><br>We, as a vast amount of people out there, have legacy Java code. A lot. In our case this legacy is pretty much crucial to our business. We can&#8217;t just trash it and start from scratch. Bad idea.<br><br>On the other hand we do have new features to be built on top of it. But we wanted an easier way to develop this new stuff and decided for a JRuby on Rails solution, using it as a front-end to our existing services.<br><br><strong>- What we decided to do</strong><br><br>Our final rails project would make use of a specially created jar file containing our Java application. This Jar would also contain a public interface of the services we&#8217;d have to interact with from rails.<br><br>As any Java application, ours depend on a number of external jar files that correspond to the various framewoks we usually have in place. e.g.: Hibernate, Spring, apache-commons &#8230;<br><br>Which means we need to make our app&#8217;s jar and all it&#8217;s dependencies available in the JRuby classpath in order to use it.<br><br>Given we&#8217;re using warbler to package our application as a war file, we just need to place all jars needed into our rails app&#8217;s lib folder. Warbler then takes care of copying any jar files located in there into the war.<br><br><strong>- The problem</strong><br><br>So we needed a smart way to include all these dependencies into the project, and copy/paste isn&#8217;t an option.<br><br>In the Java world we use <a href="http://maven.apache.org/">Maven</a> to manage our projects dependencies - and you should too. Because of that our approach involved turning our rails application into a Maven aware project.<br><br>Basically we needed a <a href="http://maven.apache.org/pom.html">pom file</a> that would declaratively list our java project as a dependency. From there on, Maven knows what the dependencies are and downloads them to your local repository.<br><br>Which leaves us with one more task. We need to put all these dependencies into our lib folder after maven has downloaded them.<br><br>Below you&#8217;ll find the pom.xml file that we use to achieve this with inline comments explaining each bit:<br>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
</span><span class='line'>  <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;groupId&gt;</span>com.company<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>  <span class="c">&lt;!-- notice how we specify the packaging to be a war,</span>
</span><span class='line'><span class="c">          that way, maven knows where to copy the jar files --&gt;</span>
</span><span class='line'>  <span class="nt">&lt;packaging&gt;</span>war<span class="nt">&lt;/packaging&gt;</span>
</span><span class='line'>  <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>  <span class="nt">&lt;artifactId&gt;</span>railsApp<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>  <span class="nt">&lt;name&gt;</span>railsApp<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>    <span class="nt">&lt;dependencies&gt;</span>
</span><span class='line'>        <span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>            <span class="nt">&lt;groupId&gt;</span>com.company<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>            <span class="nt">&lt;artifactId&gt;</span>java-legacy-app<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>            <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>            <span class="nt">&lt;scope&gt;</span>compile<span class="nt">&lt;/scope&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/dependencies&gt;</span>
</span><span class='line'>    <span class="nt">&lt;build&gt;</span>
</span><span class='line'>        <span class="nt">&lt;finalName&gt;</span>railsApp<span class="nt">&lt;/finalName&gt;</span>
</span><span class='line'>        <span class="nt">&lt;plugins&gt;</span>
</span><span class='line'>      <span class="nt">&lt;plugin&gt;</span>
</span><span class='line'>        <span class="nt">&lt;groupId&gt;</span>org.codehaus.mojo<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;artifactId&gt;</span>exec-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;executions&gt;</span>
</span><span class='line'>          <span class="nt">&lt;execution&gt;</span>
</span><span class='line'>            <span class="c">&lt;!-- This tasks only creates a basic structure expected by maven,</span>
</span><span class='line'><span class="c">                    so it can do its work --&gt;</span>
</span><span class='line'>            <span class="nt">&lt;id&gt;</span>create-mock-web-descriptor<span class="nt">&lt;/id&gt;</span>
</span><span class='line'>            <span class="nt">&lt;phase&gt;</span>compile<span class="nt">&lt;/phase&gt;</span>
</span><span class='line'>            <span class="nt">&lt;configuration&gt;</span>
</span><span class='line'>              <span class="nt">&lt;executable&gt;</span>/bin/sh<span class="nt">&lt;/executable&gt;</span>
</span><span class='line'>              <span class="nt">&lt;workingDirectory&gt;</span>.<span class="nt">&lt;/workingDirectory&gt;</span>
</span><span class='line'>              <span class="nt">&lt;arguments&gt;</span>
</span><span class='line'>                <span class="nt">&lt;argument&gt;</span>-c<span class="nt">&lt;/argument&gt;</span>
</span><span class='line'>                <span class="nt">&lt;argument&gt;</span>
</span><span class='line'>                    mkdir -p src/main/webapp/WEB-INF
</span><span class='line'>                    touch    src/main/webapp/WEB-INF/web.xml
</span><span class='line'>                <span class="nt">&lt;/argument&gt;</span>
</span><span class='line'>              <span class="nt">&lt;/arguments&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/configuration&gt;</span>
</span><span class='line'>            <span class="nt">&lt;goals&gt;</span>
</span><span class='line'>              <span class="nt">&lt;goal&gt;</span>exec<span class="nt">&lt;/goal&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/goals&gt;</span>
</span><span class='line'>          <span class="nt">&lt;/execution&gt;</span>
</span><span class='line'>          <span class="nt">&lt;execution&gt;</span>
</span><span class='line'>            <span class="c">&lt;!-- Now in the package phase we copy the jar files</span>
</span><span class='line'><span class="c">                    that maven put into the fake web app to our rails&#39; lib folder --&gt;</span>
</span><span class='line'>            <span class="nt">&lt;id&gt;</span>copy-needed-jars-into-lib<span class="nt">&lt;/id&gt;</span>
</span><span class='line'>            <span class="nt">&lt;phase&gt;</span>package<span class="nt">&lt;/phase&gt;</span>
</span><span class='line'>            <span class="nt">&lt;configuration&gt;</span>
</span><span class='line'>              <span class="nt">&lt;executable&gt;</span>/bin/sh<span class="nt">&lt;/executable&gt;</span>
</span><span class='line'>              <span class="nt">&lt;workingDirectory&gt;</span>.<span class="nt">&lt;/workingDirectory&gt;</span>
</span><span class='line'>              <span class="nt">&lt;arguments&gt;</span>
</span><span class='line'>                <span class="nt">&lt;argument&gt;</span>-c<span class="nt">&lt;/argument&gt;</span>
</span><span class='line'>                <span class="nt">&lt;argument&gt;</span>
</span><span class='line'>                    rm -f lib/*.jar
</span><span class='line'>                    cp target/railsApp/WEB-INF/lib/*.jar lib
</span><span class='line'>                    rm -rf target/railsApp*
</span><span class='line'>                    rm -rf src
</span><span class='line'>                <span class="nt">&lt;/argument&gt;</span>
</span><span class='line'>              <span class="nt">&lt;/arguments&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/configuration&gt;</span>
</span><span class='line'>            <span class="nt">&lt;goals&gt;</span>
</span><span class='line'>              <span class="nt">&lt;goal&gt;</span>exec<span class="nt">&lt;/goal&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/goals&gt;</span>
</span><span class='line'>          <span class="nt">&lt;/execution&gt;</span>
</span><span class='line'>          <span class="nt">&lt;execution&gt;</span>
</span><span class='line'>           <span class="c">&lt;!-- Here we optionally create the final war file containing our rails app using warbler,</span>
</span><span class='line'><span class="c">                     doing a small cleanup of the files and folders maven created  --&gt;</span>
</span><span class='line'>            <span class="nt">&lt;id&gt;</span>create-final-war<span class="nt">&lt;/id&gt;</span>
</span><span class='line'>            <span class="nt">&lt;phase&gt;</span>package<span class="nt">&lt;/phase&gt;</span>
</span><span class='line'>            <span class="nt">&lt;configuration&gt;</span>
</span><span class='line'>              <span class="nt">&lt;executable&gt;</span>/bin/sh<span class="nt">&lt;/executable&gt;</span>
</span><span class='line'>              <span class="nt">&lt;workingDirectory&gt;</span>.<span class="nt">&lt;/workingDirectory&gt;</span>
</span><span class='line'>              <span class="nt">&lt;arguments&gt;</span>
</span><span class='line'>                <span class="nt">&lt;argument&gt;</span>-c<span class="nt">&lt;/argument&gt;</span>
</span><span class='line'>                <span class="nt">&lt;argument&gt;</span>
</span><span class='line'>                   rm -rf *.war tmp/war
</span><span class='line'>                   jruby -S warble <span class="ni">&amp;amp;&amp;amp;</span> \
</span><span class='line'>                   mv *.war target/railsApp.war
</span><span class='line'>                <span class="nt">&lt;/argument&gt;</span>
</span><span class='line'>              <span class="nt">&lt;/arguments&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/configuration&gt;</span>
</span><span class='line'>            <span class="nt">&lt;goals&gt;</span>
</span><span class='line'>              <span class="nt">&lt;goal&gt;</span>exec<span class="nt">&lt;/goal&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/goals&gt;</span>
</span><span class='line'>          <span class="nt">&lt;/execution&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/executions&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/plugin&gt;</span>
</span><span class='line'>     <span class="nt">&lt;/plugins&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/build&gt;</span>
</span><span class='line'><span class="nt">&lt;/project&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<br><br>Now from the command line we can just run <em>mvn package</em> and we&#8217;re good to go.<br><br>Maven will start to package the application as a war file. Since it&#8217;s not a Java application we create the empty web.xml file in the compile phase, to fool maven. <br><br><br>After it has copied all the dependencies into WEB-INF/lib the next packaging goals will make sure we copy them to our rails&#8217; lib folder, also creating the final war file, ready for deployment.<br><br><br>Note that once done, you can use a simple code snippet similar to this one as an initializer and load all dependencies:<br><pre lang="ruby"><br>Dir.entries("#{RAILS_ROOT}/lib").sort.each do |entry|<br>  if entry =~ /.jar$/<br>    require entry<br>  end<br>end<br></pre><br><br>Then we can just use script/console, script/server and so on, as we normally would.<br><br>Sorry for the long post, I tried to pack in as much as I could and I certainly hope it&#8217;s useful to someone. Any doubts, comments and etc&#8230; just drop me a line. :)
</p>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2009-07-01T00:00:00+10:00" pubdate data-updated="true">Jul 1<span>st</span>, 2009</time></div>
	<div class="tags">


	<a class='category' href='/writings/tags/jruby/'>JRuby</a>, <a class='category' href='/writings/tags/java/'>Java</a>, <a class='category' href='/writings/tags/rails/'>Rails</a>


</div>
	
</div></article>

<nav id="pagenavi">
    
        <a href="/writings/writings/page/6/" class="prev">Prev</a>
    
    
        <a href="/writings/writings/page/8/" class="next">Next</a>
    
    <div class="center"><a href="/writings/blog/archives">Blog Archives</a></div>
</nav></div>
	<footer id="footer" class="inner">Copyright &copy; 2018

    Leonardo Borges

</footer>
	<script src="/writings/javascripts/slash.js"></script>
<script src="/writings/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'leonardoborges';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-2811271-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>