<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Sphinx on Leonardo Borges</title>
    <link>http://leonardoborges.com/tags/sphinx/</link>
    <description>Recent content in Sphinx on Leonardo Borges</description>
    <generator>Hugo</generator>
    <language>en-us</language>
    <lastBuildDate>Wed, 13 Jan 2010 00:00:00 +0000</lastBuildDate>
    <atom:link href="http://leonardoborges.com/tags/sphinx/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>monit thinking sphinx and rvm</title>
      <link>http://leonardoborges.com/writings/2010/01/13/monit-thinking-sphinx-and-rvm/</link>
      <pubDate>Wed, 13 Jan 2010 00:00:00 +0000</pubDate>
      <guid>http://leonardoborges.com/writings/2010/01/13/monit-thinking-sphinx-and-rvm/</guid>
      <description>&lt;p&gt;&#xA;In one of my Rails projects I&#39;m using &lt;a href=&#34;http://www.sphinxsearch.com/&#34; target=&#34;_blank&#34;&gt;Sphinx&lt;/a&gt; to provide full-text search capabilities. To integrate both worlds I chose &lt;a href=&#34;http://freelancing-god.github.com/ts/en/&#34; target=&#34;_blank&#34;&gt;Thinking Sphinx&lt;/a&gt;, which is just great and so far has met all of my expectations.&lt;br&gt;&lt;br&gt;Also, &lt;a href=&#34;http://www.leonardoborges.com/writings/2010/01/02/managing-multiple-ruby-versions/&#34; target=&#34;_blank&#34;&gt;as I previously mentioned&lt;/a&gt;, I&#39;m using &lt;a href=&#34;http://rvm.beginrescueend.com/&#34;&gt;RVM&lt;/a&gt; to manage my ruby installations on both my development and production machines and this setup is what motivated this post.&lt;br&gt;&lt;br&gt;I use &lt;a href=&#34;http://mmonit.com/monit/&#34; target=&#34;_blank&#34;&gt;Monit&lt;/a&gt; to monitor the services running on my production server - nginx, mysql, php - and as of the first deploy of this application, it only made sense to also monitor Sphinx.&lt;br&gt;&lt;br&gt;In order to create an initialization script, I would need at least a way to start and stop sphinx from the command line, which, using Thinking Sphinx, can be done using these rake tasks:&lt;br&gt;&lt;pre lang=&#34;bash&#34;&gt;&lt;br&gt;$ rake thinking_sphinx:stop&lt;br&gt;$ rake thinking_sphinx:start&lt;br&gt;&lt;/pre&gt;&lt;br&gt;It&#39;s worth mentioning now that I don&#39;t run sphinx as root. I run it with the same user my rails application uses. For the purpose of this post, let&#39;s call it &lt;em&gt;deploy&lt;/em&gt;.&lt;br&gt;&lt;br&gt;When I tried using my script I got errors such as these:&lt;br&gt;&lt;br&gt;&lt;pre lang=&#34;bash&#34;&gt;&lt;br&gt;Missing the Rails 2.3.5 gem. Please `gem install -v=2.3.5 rails`, update your RAILS_GEM_VERSION setting in config/environment.rb for the Rails version you do have installed, or comment out RAILS_GEM_VERSION to use the latest version installed.&lt;br&gt;&lt;/pre&gt;&lt;br&gt;&lt;br&gt;After some digging around I found that the GEM_HOME environment variable for my deploy user wasn&#39;t being set correctly - something to do with rvm, but not quite sure - and to fix this, well, I just had to set it, leaving the final working version of my script somewhat like this - simplified :&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;#! /bin/sh&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;### BEGIN INIT INFO&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;### END INIT INFO&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;set_path&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;cd /your/rails/app/root; export GEM_HOME=/path/to/your/gems; RAILS_ENV=production;&amp;#34;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;case&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;$1&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt; in&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  start&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        echo -n &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Starting sphinx: &amp;#34;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                su - deploy -c &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;$set_path&lt;span style=&#34;color:#e6db74&#34;&gt; rake ts:start&amp;#34;&lt;/span&gt; &amp;gt;&amp;gt; /var/log/sphinx.log 2&amp;gt;&amp;amp;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        echo &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;done.&amp;#34;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        ;;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  stop&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        echo -n &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Stopping sphinx: &amp;#34;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                su - deploy -c &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;$set_path&lt;span style=&#34;color:#e6db74&#34;&gt; rake ts:stop&amp;#34;&lt;/span&gt; &amp;gt;&amp;gt; /var/log/sphinx.log 2&amp;gt;&amp;amp;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        echo &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;done.&amp;#34;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        ;;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      *&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            N&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;/etc/init.d/sphinx&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            echo &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Usage: &lt;/span&gt;$N&lt;span style=&#34;color:#e6db74&#34;&gt; {start|stop}&amp;#34;&lt;/span&gt; &amp;gt;&amp;amp;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            exit &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            ;;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;esac&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;exit &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;There are 2 things happening here. First, regardless of the user I&amp;rsquo;m running this init script as, I drop privileges in order to execute the rake task with my deploy user. Second, I set the GEM_HOME environment variable to stop getting the &amp;lsquo;gem not found&amp;rsquo; errors.&lt;br&gt;&lt;br&gt;After that, monit was able not only to monitor my sphinx instance, but also (re)start/stop it with the correct user.&lt;br&gt;&lt;br&gt;I&amp;rsquo;m no Linux wizard so if you wanna suggest improvements to this script, feel free to do so!&lt;/p&gt;</description>
    </item>
  </channel>
</rss>
